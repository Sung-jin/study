## 스트림 병렬화는 주의해서 적용하라

* 자바에서 동시성 프로그램을 작성하기는 점점 쉬워지지만, 이를 올바르고 빠르게 작성하는 일은 어렵다
    * 동시성 프로그래밍을 할 때는 안전성과 응답 가능 상태를 유지하기 위해 애써야 한다
    
```java
public static void main(String[] args) {
    primes().map(p -> TWO.pow(p.intValueExact()).substract(ONE))
        .filter(mersenne -> mersenne.isProbablePrime(50))
        .limit(20)
        .forEach(System.out::println);
    // 위 코드의 속도를 높이기 위해 단순히 paralle() 을 호출할 경우
    // 아무것도 출력하지 못하는 응답 불가 상태가 된다
}

static STream<BigInteger> primes() {
    return Stream.iterate(TWO, BigInteger::nextProbablePrime);
}
```

* 환경이 좋더라도 데이터 소스가 `Stream.iterate` 거나 중간 연산으로 `limit` 을 사용하면 파이프라인 병렬화로 성능 개선을 기대할 수 없다
    * 파이프라인 병렬화는 limit 를 다룰 때 CPU 코어가 남는다면 원소 몇 개 더 처리한 후 제한된 개수 이후의 결과를 버려도 아무런 해가 없다고 가정한다
    * 메르센 소수는 그 전 소수를 찾을 때보다 두 배정도 더 오래 걸린다
    * 즉, 원소 하나를 계산하는 비용은 이전까지의 원소를 전부 계싼한 비용을 합친 것만큼 든다는 것을 의미한다
    * 이는 코드를 병렬화를 위해 `paralle()` 을 호출할 경우, 자동 병렬화 알고리즘이 제 기능을 못하게 마비시킨다
* 따라서 스트림파이프 라인을 마구잡이로 병렬화하면 성능이 오히려 끔직하게 나빠질 수 있다

### 스트림 병렬화가 좋은 경우

* 스트림의 소스가 ArrayList, HashMap, HashSet, ConcurrentHashMap 의 인스턴스거나 배열, int 범위, long 범위일 때 병렬화의 효과가 가장 좋다
    * 위의 자료구조는 데이터를 원하는 크기로 정확하고 손쉽게 나눌 수 있어서 작업을 다수의 스레드에 분배하기에 좋다는 특징이 있다
    * 또한 원소들을 순차적으로 실행할 때의 참조 지역성이 뛰어나다
        * 참조 지역성이 낮으면 스레드는 데이터가 주 메모리에서 캐시 메모리로 전송되어 오기를 기다리는 시간이 존재한다
* 스트림 파이프라인의 종단 연산의 동작 방식도 병렬 수행 효율에 영향을 준다
    * 종단 연산 중 병렬화에 가장 적합한 것은 축소이다 (Stream 의 reduce, min, max, count, sum, anyMatch, allMatch, noneMatch)
    * 가변 축소를 수행하는 Stream 의 collect 메서드는 병렬화에 적합하지 않다
  
### 안전 실패

* 스트림을 잘못 병렬화하면 성능이 나빠질 뿐만 아니라 결과 자체가 잘못되거나 예상 못한 동작이 발생할 수 있다
    * 이러한 오동작을 안전 실패라고 한다
* 안전 실패는 병렬화한 파이프라인이 사용하는 mappers, filters 등이 명세대로 동작하지 않을 때 벌어질 수 있다

### 병렬 스트림의 한계

* 병렬화의 결과의 순서는 보장되지 않는다
    * forEachOrdered 와 같은 종단 연산을 사용하면 순서대로 출력되도록 보장해준다
* 데이터 소스 스트림이 효율적으로 나눠지고, 병렬화하거나 빨리 끝나는 종단 연산을 사용하고, 함수 객체들도 간섭하지 않더라도 병렬 스트림의 성능이 무조건 좋다고 보장할 수 없다
    * 병렬화에 드는 추가 비용 등이 존재한다
    * 성능 향상 여부를 추정하는 방법: 스트림 안의 원소 수와 원소당 수행되는 코드 줄 수를 곱한 결과가 수십만은 되어야 성능 향상을 예상할 수 있다
* 스트림 병렬화는 오직 성능 최적화 수단임을 기억해야 한다
* 병렬 스트림 파이프라인도 공통의 포크-조인 풀에서 수행되므로 잘못된 파이프라인 하나가 시스템의 다른 부분의 성능까지 악영향을 줄 수 있음을 유의해야 한다

## 정리

* 계산도 올바로 수행하고 성능도 빨라질 거라는 확신 없이는 스트림 파이프라인 병렬화는 시도조차 하지 말아야 한다
* 스트림을 잘못 병렬화하면 프로그램을 오동작하게 하거나 성능을 급격히 떨어뜨린다
* 병렬화를 진행할 경우 운영 환경과 유사한 조건에서 수행하여 성능 지표를 관찰 후 계산이 정확하고 성능이 좋아졌음이 확실할 때만 병렬화 코드를 적용하는게 좋다
